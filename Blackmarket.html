<!DOCTYPE html>
<html>
<head>
    <title>NOH Black Market Terminal</title>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: 'Consolas', 'Courier New', monospace;
            background-color: #1a1a1a; /* Dark grey */
            color: #00FF00; /* Green terminal text */
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            background-color: #0a0a0a; /* Near black */
            border: 2px solid #333333;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.2);
            padding: 25px;
            width: 80%;
            max-width: 800px;
            text-align: center;
        }
        h1 {
            color: #FF4500; /* Orangey-red */
            border-bottom: 1px dashed #555;
            padding-bottom: 10px;
            margin-bottom: 20px;
            letter-spacing: 2px;
            text-shadow: 0 0 5px #FF4500;
        }
        #kreditDisplay {
            font-size: 1.5em;
            margin-bottom: 25px;
            background-color: #111;
            padding: 10px;
            border: 1px solid #444;
            display: inline-block;
        }
        #kreditDisplay span {
            color: #FFA500; /* Gold/Orange for Kred amount */
            font-weight: bold;
        }
        .item-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* Responsive grid */
            gap: 20px;
            margin-bottom: 30px;
            text-align: left;
        }
        .item {
            background-color: #222;
            border: 1px solid #444;
            padding: 15px;
            transition: background-color 0.3s ease;
        }
        .item.purchased {
             border-color: #00FF00;
             background-color: #1a3a1a; /* Darker green tint */
        }
        .item h3 {
            color: #00FFFF; /* Cyan */
            margin-top: 0;
            margin-bottom: 5px;
            font-size: 1.1em;
        }
        .item .cost {
            color: #FFA500;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .item .desc {
            font-size: 0.9em;
            color: #cccccc; /* Light grey */
            margin-bottom: 15px;
            min-height: 40px; /* Prevent layout shift */
        }
        .buy-button {
            background-color: #8B0000; /* Dark Red */
            color: white;
            border: 1px solid #FF4500;
            padding: 8px 15px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            width: 100%;
            font-weight: bold;
        }
        .buy-button:hover:not(:disabled) {
            background-color: #FF4500; /* Brighter Red/Orange */
        }
        .buy-button:disabled {
            background-color: #333;
            color: #777;
            border-color: #555;
            cursor: not-allowed;
        }
        #returnButton {
            background-color: #0055BB; /* Concord Blue-ish */
            color: white;
            border: 1px solid #00FFFF;
            padding: 12px 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-top: 20px;
        }
        #returnButton:hover {
            background-color: #0088DD;
        }
        .error {
             color: red;
             font-weight: bold;
             margin-bottom: 20px;
        }

    </style>
</head>
<body>
    <div class="container">
        <h1>// NAPANI OFF-LEDGER HOLDINGS // SECURE TERMINAL //</h1>

        <div id="kreditDisplay">Available Kredits: <span id="kreds">--</span> NOH</div>
        <div id="errorMessage" class="error" style="display: none;"></div>

        <h2>Available Inventory: (Single Purchase Only)</h2>
        <div class="item-list" id="itemList">
            <!-- Items will be loaded here by JavaScript -->
        </div>

        <button id="returnButton">Return to Capsule</button>
    </div>

    <script>
        const ISK_TO_KRED_RATE = 100;
        const MINER_GAME_FILE = "Miners14.html"; // Must match the game file name

        // --- Item Data ---
        // (Make sure item 'id' matches the cases in Miners14.html applyItemEffects)
        const marketItems = [
            { id: 'cargo_expander_1', name: 'Cargo Expander I', cost: 50, desc: 'Increases ship cargo capacity. Standard Napanii surplus.', effect: '+50 Max Cargo' },
            { id: 'mining_laser_upgrade_1', name: 'MLU-7 "Rockeater"', cost: 120, desc: 'Modified mining laser focusing crystal. Questionable stability, improved yield.', effect: '+10 Mining Rate' },
            { id: 'afterburner_1', name: 'Smuggler\'s Afterburner', cost: 80, desc: 'Overclocked propulsion module. Runs hot, moves fast.', effect: '+80 Thrust Power' },
            { id: 'long_range_scanner', name: 'Modified Survey Scanner', cost: 70, desc: 'Boosted sensor array allows targetting asteroids from further away.', effect: '+30 Mining Range' }
            // Add more items here later
        ];

        // --- Get References ---
        const kreditDisplayEl = document.getElementById('kreds');
        const itemListEl = document.getElementById('itemList');
        const returnButtonEl = document.getElementById('returnButton');
        const errorMessageEl = document.getElementById('errorMessage');

        // --- State Variables ---
        let initialIsk = 0;
        let currentKredits = 0;
        let selectedItemId = null;
        let remainingKredits = 0;

        // --- Functions ---
        function displayError(message) {
             errorMessageEl.textContent = `ACCESS DENIED: ${message}`;
             errorMessageEl.style.display = 'block';
             // Disable everything if there's an error loading Kredits
             document.querySelectorAll('.buy-button').forEach(btn => btn.disabled = true);
             returnButtonEl.disabled = true;
        }

        function loadItems() {
            itemListEl.innerHTML = ''; // Clear previous items
            marketItems.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('item');
                itemDiv.id = `item-${item.id}`; // Add ID for potential styling later

                const title = document.createElement('h3');
                title.textContent = item.name;

                const costP = document.createElement('div');
                costP.classList.add('cost');
                costP.textContent = `Cost: ${item.cost} NOH`;

                const descP = document.createElement('div');
                descP.classList.add('desc');
                descP.textContent = item.desc;

                 const effectP = document.createElement('div'); // Show effect clearly
                effectP.classList.add('cost'); // Use same style as cost for emphasis
                effectP.textContent = `Effect: ${item.effect}`;


                const buyButton = document.createElement('button');
                buyButton.classList.add('buy-button');
                buyButton.textContent = 'Acquire';
                buyButton.dataset.itemId = item.id;
                buyButton.dataset.itemCost = item.cost;
                buyButton.disabled = currentKredits < item.cost; // Disable if can't afford

                buyButton.addEventListener('click', handleBuyClick);

                itemDiv.appendChild(title);
                itemDiv.appendChild(costP);
                itemDiv.appendChild(descP);
                itemDiv.appendChild(effectP); // Add effect display
                itemDiv.appendChild(buyButton);
                itemListEl.appendChild(itemDiv);
            });
        }

        function handleBuyClick(event) {
            if (selectedItemId) return; // Already bought something

            const button = event.target;
            const itemId = button.dataset.itemId;
            const itemCost = parseInt(button.dataset.itemCost, 10);

            if (currentKredits >= itemCost) {
                selectedItemId = itemId;
                remainingKredits = currentKredits - itemCost;
                console.log(`Bought item: ${itemId}, Remaining Kredits: ${remainingKredits}`);

                // Update UI: Disable all buttons, mark purchased
                document.querySelectorAll('.buy-button').forEach(btn => {
                    btn.disabled = true;
                    btn.textContent = "Acquired"; // Change text of bought item
                });
                 document.querySelectorAll('.item').forEach(itemDiv => {
                    if (itemDiv.id === `item-${itemId}`) {
                         itemDiv.classList.add('purchased');
                    }
                });


                kreditDisplayEl.textContent = `${remainingKredits}`; // Update display (optional)
                showMessage(`Acquired: ${marketItems.find(i => i.id === itemId)?.name || 'Unknown Item'}`, 'lime'); // Feedback
            } else {
                console.error("Insufficient Kredits - this shouldn't happen if button was enabled correctly.");
                showMessage('Error: Insufficient Kredits!', 'red');
            }
        }

        function handleReturnClick() {
            let returnUrl = MINER_GAME_FILE;
            // Always pass back kreds, even if 0 or unchanged
            const kredsToReturn = selectedItemId ? remainingKredits : currentKredits;

            if (selectedItemId) {
                returnUrl += `?item=${selectedItemId}&kreds=${kredsToReturn}`;
            } else {
                 returnUrl += `?kreds=${kredsToReturn}`; // Return without item if none bought
            }

            console.log(`Returning to: ${returnUrl}`);
            window.location.href = returnUrl;
        }

         // Simple feedback function
        function showMessage(text, color = '#00FF00') {
             // Could enhance this later, maybe a temporary message bar
             console.log(`Market Message (${color}): ${text}`);
             // Update kredit display color temporarily?
             kreditDisplayEl.style.transition = 'color 0.2s ease-out';
             kreditDisplayEl.style.color = color;
             setTimeout(() => {
                 kreditDisplayEl.style.color = ''; // Reset to default (or maybe #FFA500)
             }, 1500);
        }


        // --- Initialization ---
        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            initialIsk = parseInt(urlParams.get('isk'), 10);

            if (isNaN(initialIsk) || initialIsk <= 0) {
                displayError("INVALID ACCESS CREDENTIALS (No ISK found). Cannot establish secure connection.");
                return; // Stop initialization
            }

            currentKredits = Math.floor(initialIsk / ISK_TO_KRED_RATE);
            remainingKredits = currentKredits; // Initially, remaining is the total
            kreditDisplayEl.textContent = currentKredits;

            console.log(`Received ISK: ${initialIsk}, Converted to Kredits: ${currentKredits}`);

            loadItems(); // Display items now that we know the Kredits

            returnButtonEl.addEventListener('click', handleReturnClick);
        };

    </script>
</body>
</html>